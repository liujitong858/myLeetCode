# 第三章 数据链路层

## 3.1 数据链路层的基本概念

### 3.1.1 数据链路层的简单模型

- 数据链路层不关心物理层解决的问题，只关心帧头帧尾和校验。

 ![在这里插入图片描述](https://img-blog.csdnimg.cn/20200102231430200.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2l3YW5kZXJ1,size_16,color_FFFFFF,t_70) 

### 3.1.2 数据链路层的信道类型

- 点到点信道：这种信道使用一对一的点对点通信方式
- 广播信道：广播信道上的主机很多，需要专用的共享信道协议来协调主机的数据发送

### 3.1.3 链路与数字链路

- 链路：是一条点到点的物理线路段，中间没有任何其他交换结点。一条链路只是一条通路的一个组成部分。
- 数据链路：除了物理线路外，还必须有通讯协议来控制这些数据的传输。若把实现这些协议的硬件和软件加到链路上。最常用的方法就是使用网络适配器来实现这些协议的软件和硬件。一般的适配器都包括了数据链路层和物理层这两层的功能。

### 3.1.4 帧

-  在网络层，给数据包增加了接收端和发送端的IP地址。在数据链路层里，增加了帧头帧尾，MAC地址和校验值。 

 ![在这里插入图片描述](https://img-blog.csdnimg.cn/20200102231525963.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2l3YW5kZXJ1,size_16,color_FFFFFF,t_70) 

## 3.2 数据链路层解决的基本问题

### 3.2.1 封装成帧

-  就是在一段数据的前后分别添加帧头和帧尾，构成一个帧，确定帧的界限。 

 ![在这里插入图片描述](https://img-blog.csdnimg.cn/20200102231600571.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2l3YW5kZXJ1,size_16,color_FFFFFF,t_70) 

- 可能数据部分中出现与帧首和帧尾相同的字符。

 ![在这里插入图片描述](https://img-blog.csdnimg.cn/20200102231622678.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2l3YW5kZXJ1,size_16,color_FFFFFF,t_70) 

### 3.2.2 透明传输

- 用字节填充法解决透明传输问题。发送端的数据链路层在数据中出现控制字符“SOH”或“EOT”的前面插入一个转义字符 “ESC”(十六进制数1B)。 
-  字节填充(byte stuffing)或字符填充(character stuffing)——接收端的数据链路层在数据送往网络层之前检出插入的转义字符。 

-  如果转义字符也出现在数据之中，那么应该在转义字符前插入一个转义字符。当接收端收到连续的两个转义字符时，就删除前面的那一个。 

 ![在这里插入图片描述](https://img-blog.csdnimg.cn/20200102231659526.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2l3YW5kZXJ1,size_16,color_FFFFFF,t_70) 

### 3.2.3 差错校验

- 传输过程中可能会产生bit差错：0变成1，1变成0.
- 在一段时间内，传输错误的比特率占所传输比特总数的比率称为误码率BER(bit error rate)。
- 误码率和信噪比的关系很大。
- 为了保证数据传输的可靠性，在计算机网络传输数据时，必须采用各种差错检验措施。
- **循环冗余检验CRC:**
- 除数必须比后面添加的0的位数多一位，可以是任意的二进制数。**每一步运算其实是不进位的加法**。下图的001就是FCS帧检验序列。接收端计算101001001(也就是原数据加上FCS)除以1101，如果商为0，意味着传输过程没有差错，就接受，否则丢弃。

 ![在这里插入图片描述](https://img-blog.csdnimg.cn/20200102231718200.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2l3YW5kZXJ1,size_16,color_FFFFFF,t_70) 

- 在数据后面添加的冗余码称为**帧检验序列FCS**(frame check seqeunce)。CRC不是获得FCS的唯一方法。

- 特点：

  - 不能确定出错的bit的是哪一位；

  - 可能会出错，但只要经过严格的挑选，并且除数位数足够大，就可以极大减少出错概率；
  - CRC只能做到无差错接受(意思是传输过程没有差错，有差错的一律丢弃)；
  - 不是可靠传输。要做到可靠传输，必须加上确认和重传机制。

## 3.3 两种情况下得数据链路层

### 3.3.1 使用点对点信道得数据链路层（广域网)

- PPP协议(point to point protocol)，是数据链路层协议，例如用户使用拨号上网。
- PPP协议应该满足：
  - 简单；**封装成帧**；**透明性**；多种网络层协议；多种类型链路；**差错检验**；检测连接状态；最大传送单元；**网络层地址协商**；数据压缩协商；

- PPP协议不需要满足：
  - 纠错；流量控制；序号；多点链接；半双工或单工连接。
- PPP协议的组成部分：
- 数据链路层协议可以用于异步串行或同步串行介质；
- **使用LCP(链路控制协议)建立并维护数据链路连接，可以实现身份验证和欠费管理；**
- **网络控制协议(NCP)允许在点到点连接上使用多种网络层协议，如下图；**

 ![在这里插入图片描述](https://img-blog.csdnimg.cn/2020010223174734.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2l3YW5kZXJ1,size_16,color_FFFFFF,t_70) 

-  PPP协议帧格式
  - 标志字段F = 0x7E
  - 地址字段A = 0xFF，它并不起作用
  - 控制字段C = 0x03
  - PPP协议是面向字节的，所以所有的PPP帧的长度都是整数字节。 

 ![在这里插入图片描述](https://img-blog.csdnimg.cn/20200102231805348.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2l3YW5kZXJ1,size_16,color_FFFFFF,t_70) 

- 字节填充(类似于透明传输)

  - 此时，信息部分是以字节为单位的。
    将信息字段中出现的每个0x7E字节转变成为2字节序列(0x7D,0x5E);
    将信息字段中出现的每个0x7D字节转变成为2字节序列(0x7D,0x5D);
    将信息字段中出现的每个ASCII码控制字符(小于0x20字符)，在前面加入一个0x7D；
  - 由于在发送端进行了字节填充，因此在链路上传送的信息字节就超过了原来的信息字节数。但接收端在收到数据后再进行与发送端字节填充相反的变换，就可以正确地恢复出原来的信息。

-  0比特填充(类似于透明传输)

  - 此时，信息部分是二进制流。PPP协议在SONET/SDH链路时，是使用同步传输。
  - **在发送端，只要发现有5个连续的1，则填充一个0，接收端删掉对应的0。** 

   ![在这里插入图片描述](https://img-blog.csdnimg.cn/20200102231832418.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2l3YW5kZXJ1,size_16,color_FFFFFF,t_70) 

- 同步传输与异步传输的区别：
  - 同步传输 :面向比特，一次传输一个帧，即一连串的比特连续传送
  - 异步传输：面向字符的传输，逐个字符的传输
-  PPP协议不使用序号和确认机制的原因 ：
  -  在数据链路层出现错误的概率不大时，使用较简单的PPP协议较为合理；
  - 在Internet环境下，**PPP的信息字段放入的数据是IP数据报。数据链路层的可靠传输并不能保证网络层的传输也是可靠的；**
  - 帧检验序列FCS字段可以保证无差错接受。 
-  PPP协议的工作状态 ：
  - 当用户拨号接入ISP(网络运营商)时，路由器的调制解调器对拨号进行确认，建立物理连接；
  - PC机箱路由器发送一些列的LCP(链路控制协议)分组(封装成多个PPP帧)；
  - 这些分组及其响应选择一些PPP参数，和进行网络层配置，NCP(网络控制协议)给新接入的PC机分配一个临时的IP地址，使PC机成为Internet上的一个主机；
  - 通信完毕后，NCP释放网络层连接，收回原来分配出去的IP地址；
  - 接着，LCP释放数据链路层连接；
  - 最后释放物理层连接。

### 3.3.2 使用广播信道的数据链路层（局域网）

- 一般是总线型

 ![在这里插入图片描述](https://img-blog.csdnimg.cn/2020010223185676.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2l3YW5kZXJ1,size_16,color_FFFFFF,t_70) 

- 共享通信媒体
  - 静态划分信道(麻烦)：
    频分复用；时分复用；波分复用；码分复用；
  - 动态媒体接入控制(多点接入)：
    随机接入(主要是以太网)；受控接入，如多点线路探询(polling)，轮询(不采用了)。 
-  认识以太网 ：
- 最初的以太网是将许多计算机都连接到一根总线上，当初认为这样连接即简单又可靠，因为总线上没有有源器件。
- **总线上每一个主机都能检测到B发送的数据。但是只有D的地址和数据帧首部写入的地址一致，所以只有D接收。其余计算机都能检测到这不是发送给他们的数据帧，所以就丢弃这个数据帧。**
- 这是一种具有**广播特性的总线**上实现了一对一通信。这种方式不安全。

 ![在这里插入图片描述](https://img-blog.csdnimg.cn/20200102231909360.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2l3YW5kZXJ1,size_16,color_FFFFFF,t_70) 

- **带冲突检测的载波监听/碰撞检测**
  **CSMA/CD**：Carrier Sense Multiple Access with Collision Detection
  - 多点接入：许多计算机以多点接入的方式连接在一根总线上。
  - 载波监听：每一个站在发送数据之前都先要用电子技术检测一下总线时候有其它计算机在发送数据信号，**如果有则不发送数据，以免发生碰撞；**
- 碰撞检测：碰撞检测就是计算机边发送数据边**检测信道上信号电压的大小。**
  - 当几个站同时在总线上发送数据时，总线上的信号电压摆动值将会增大；
  - 当一个站检测到信号电压摆动值超过一定的门限值时，就认为总线上至少有两个站在同时发送数据，表明产生了碰撞；
  - 碰撞就是冲突，碰撞检测也称冲突检测。
  - 检测到碰撞后：在发生碰撞时，总线上传输的信号产生了严重的失真，无法从中恢复出有用的信息；
  - **每一个正在发送数据的站，一旦发现总线上出现了碰撞，就立即停止发送，避免浪费网络资源，等待一个随机的时间后再次发送。**